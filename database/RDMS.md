# 关系型数据库

## 主键、超键、候选键、外键是什么

- **超键**：在关系中能唯一标识**元组的属性集**称为关系模式的超键
- **候选键**：不含有**多余属性的超键**称为候选键。也就是在候选键中，若再删除属性，就不是键了
- **主键**：**用户选作元组标识的一个候选键程序主键**
- **外键**：如果关系模式**R中属性K是其它模式的主键**，那么**k在模式R中称为外键**
- 主键与索引的区别
  - 主键一定是唯一性索引，唯一性索引并不一定是主键
  - 主键可以唯一的标识表中的某一行的属性或者属性组
  - 主键列不允许为空，但是索引可以为空
## RDMS与非关系型数据库区别
- 关系型数据库
  - 采用了关系模型来组织数据
  - 保持数据的一致性
  - 数据更新的开销比较小
  - 支持复杂查询
- 非关系型数据库
  - 不需要经过SQL层的解析，读写效率高
  - 基于键值对，数据的扩展性很好
  - 支持多种类型数据的存储
  - 适用场景：
    - 数据量大、高可用、日志系统等

## RDMS中SQL执行过程
- 连接器
- 查询缓存，此前是否执行过语句
- SQL引擎
  - Paser：词法分析与语法分析生成语法树，并对语法树进行合法性检验
  - Optimizer：根据生成的语法树，按照规则或代价产生执行计划树
  - Executor：根据计划树执行，常用模型为**火山模型**
- 存储引擎
  - Buffer Pool：缓存数据，减少I/O开销
  - Page：数据存储基本单位
  - B+ Tree：InnoDB常用索引结构
- 事务引擎
  - ACID

## RDMS企业实践的问题
### 请求流量非常大
- 问题
  - 单节点数据容量有限
  - 单节点写容易成为瓶颈

- 解决方法：Sharding
  - 业务数据水平拆分：数据拆分并存储在多台服务器
  - 代理层分片路由：增加服务器数量

### 流量突增
- 问题
  - 活动期间流量上涨
  - 集群性能不满足要求

- 解决方法1：扩容
  - 扩容DB物理节点数量
- 解决方法2：代理连接池
  - 业务侧预热连接池
  - 代理侧预热连接池
  - 代理侧支持连接队列

### 可靠性与稳定性
- 问题
  - DB所在机器宕机

- 解决方法：HA管理
  - ha服务监管，切换宕机节点
  - 代理支持配置热加载
  - 代理自动屏蔽宕机读节点


## MySQL主从复制原理
类似于Kafka的主从复制

主从复制是指一台服务器充当主数据库服务器，另一台或多台服务器充当从数据库服务器，主服务器中的数据自动复制到从服务器之中

MySQL主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新

主要有3个线程参与
- 主节点log dump：发送和读取bin-log的内容。读取时会加锁，读完，在发送给从节点之前，释放锁
- 从节点I/O线程：请求主库中更新的bin-log，获得更新后保存在本地relay-log
- 从节点SQL线程：读取relay-log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性

1. 从节点的I/O进程连接主节点，请求指定日志的指定位置后的内容
2. 主节点收到请求，通过负责复制的I/O进程（log dump现场）读取指定信息，返回给从节点。此外包含bin-log和big-log中下一个指定更新位置
3. 从节点I/O进程收到日志内容、文件及位置点，将内容更新到本地relay-log中，将bin-log和位置保存在master-info文件中，以便下一次告诉master从某个bin-log的哪个位置后内容
4. 从节点SQL现场检测到relay-log中新增内容，解析为主节点实际执行的MySQL，在本数据库中按照解析出的顺序执行

主从同步分为三种：

- 异步模式：主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理
- 半同步模式：主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay-log中才返回成功信息给客户端；一旦等待超过超时时间，切换异步模式
- 全同步模式：当主库执行完一个事务，然后所有的从库都复制了该事务并成功执行完才返回成功信息给客户端